<!DOCTYPE html>
<html>
<head>
  <title>AI Quiz Generator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
  <style>
    .question {
      margin-bottom: 50px;
    }
    .submit-quiz {
        float: right;
    }
    button {
      margin-left: 20px;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #quiz-container {
      margin-bottom: 50px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <h1>AI Quiz Generator</h1>
            <hr />
        </div>
    </div>
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="form-inline">
                <div class="form-group mb-2">
                  <input type="number" class="form-control" id="numQuestions" placeholder="Number of Questions">
                </div>
                <div class="form-group mx-sm-2 mb-2">
                  <input type="number" class="form-control" id="numOptions" placeholder="Number of Options">
                </div>
                <div class="form-group mx-sm-2 mb-2">
                  <input type="text" class="form-control" id="subject" placeholder="Subject here">
                </div>
                <button type="submit" class="btn btn-primary mb-2" onclick="generateQuiz()">Generate Quiz</button>
                <button type="submit" class="btn btn-danger mb-2" onclick="reloadPage()">Restart</button>
              </div>
              <hr />
        </div>
    </div>
    <div id="quiz-container"></div>



  <script>

    /* UTILS FUNCTIONS */
    /* **************************************************
    ************************************************** */

    // Validate if JSON returned from api matches the template
    function validateJSON(jsonData, jsonTemplate) {
      for (const key in jsonTemplate) {
        if (!jsonData.hasOwnProperty(key)) {
          return false; // Key does not exist in the JSON data
        }

        if (typeof jsonData[key] !== typeof jsonTemplate[key]) {
          return false; // Type mismatch for the key
        }

        if (typeof jsonData[key] === 'object' && !Array.isArray(jsonData[key])) {
          if (!validateJSON(jsonData[key], jsonTemplate[key])) {
            return false; // Recursive call for nested objects
          }
        }
      }

      return true; // JSON matches the template structure
    }

    // force page reload
    function reloadPage() {
      location.reload(true)
    }

    // create an HTML element and add css classes
    function createEl (elType, className) {
        const el = document.createElement(elType)
        if (className) {
            classes = className.split(" ")
            classes.forEach(className => {
                el.classList.add(className)
            })
        }

        return el
    }

    function isInt(value) {
      return typeof value === 'number' && Number.isInteger(value)
    }
    
              // when the answer is "a" for an option like "a. that's my option"
          if (isChar(correctAnswer))
              question.answer = charToInt(correctAnswer)
          // when the answer is a string match of the option
          if (isString(correctAnswer))
            question.answer = question.options.indexOf(correctAnswer)function isString(value) {
      return typeof value === 'string' && value.length > 1;
    }

    function isChar(value) {
      return typeof value === 'string' && value.length === 1;
    }

    // set value to myQuiz key in localStorage
    function setQuiz(myQuiz) {
      localStorage.setItem('myQuiz', JSON.stringify(myQuiz));
    }

    // get value of myQuiz key from localStorage
    function getQuiz() {
      return JSON.parse(localStorage.getItem('myQuiz'));
    }

    // renders a loading gif to the UI
    function startLoading() {
      const loadingdiv = createEl("div", "loading")
      loadingdiv.id = "loading"
      const loadingImg = createEl("img")
      loadingImg.src = "loading.gif"
      loadingdiv.appendChild(loadingImg)

      const quizContainer = document.getElementById("quiz-container");
      quizContainer.appendChild(loadingdiv)
    }

    // remove the loading gif from the UI
    function stopLoading() {
      const el = document.getElementById("loading")
      el.remove();
    }

    // renders a alert with an error message in the UI
    function showError(err) {
      const errDiv = createEl("div", "alert alert-danger")
      errDiv.innerText = err

      const quizContainer = document.getElementById("quiz-container");
      quizContainer.appendChild(errDiv)     
    }

    function showAllBadges() {
      const quizContainer = document.getElementById("quiz");
      const badges = quizContainer.getElementsByClassName("badge");
      for (let i = 0; i < badges.length; i++) {
        badges[i].style.display = "inline";
      }
    }

    function updateResults(score, totalOfQuestions) {
      const resultContainer = document.getElementById("result");
      resultContainer.textContent = "Your Score: " + score + "/" + totalOfQuestions;
    }

    function charToInt(char) {
      const lowercaseChar = char.toLowerCase();
      if (lowercaseChar >= 'a' && lowercaseChar <= 'z') {
        return lowercaseChar.charCodeAt(0) - 'a'.charCodeAt(0) + 1;
      } else {
        return -1; // Return -1 for non-alphabetic characters
      }
    }



    /* ONPEAN AI */
    /* **************************************************
    ************************************************** */

    const OPENAI_API_KEY = "you key here"
    const OPEN_AI_URL = "https://api.openai.com/v1/chat/completions"

    // JSON structure expected to be returned from openai api
    const jsonTemplate = {
      questions: [
        {
          question: '',
          options: [''],
          answer: 0
        }
      ],
    };

    // return a payload to be used in openai api
    const generatePayloadToApi = (numQuestions, numOptions, subject) => {
      return {
        model: "gpt-3.5-turbo",
        messages: [{
          "role": "user",
          "content": `given the json template {questions: [{question: '',options: [''],answer:'' }]}, create a json with ${numQuestions} multiple choice questions with ${numOptions} options each asking about ${subject}`
        }]
      }
    }

    // fetch Openai v1/chat/completions
    const fetchChatCompletions = async (data) => {
      const response = await fetch(OPEN_AI_URL, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify(data)
      })

      return await response.json()
    }

    // extract and parse openai response
    const parseOpenaiResponseToJson = (response) => {
      const quizData = JSON.parse(response.choices[0].message.content)

      // log the value for testing
      console.log('QUIZ DATA', JSON.stringify(quizData))

      if (validateJSON(quizData, jsonTemplate)) {
        quizData.questions.forEach(question => {
          correctAnswer = question.answer
          
          // when the answer is "a" for an option like "a. that's my option"
          if (isChar(correctAnswer))
              question.answer = charToInt(correctAnswer)
          
          // when the answer is a string match of the option
          if (isString(correctAnswer))
            question.answer = question.options.indexOf(correctAnswer)
        })
        myQuiz = quizData.questions
        return myQuiz
      }

      throw new Error("JSON returned is not valid")
    }



    /* ELEMENT CREATION FUNCTIONS */
    /* **************************************************
    ************************************************** */

    // creates the Footer with the Submit Quiz btn
    function createSubmitQuizFooter() {
      const rowDiv = createEl("div", "row")
      const colDiv = createEl("div", "col-md-10 offset-md-1")
      rowDiv.appendChild(colDiv)

      btn = createEl("button", "btn btn-primary submit-quiz")
      btn.textContent = "Submit Quiz"
      btn.onclick = submitQuiz

      colDiv.appendChild(btn)

      return rowDiv
    }

    // creates the footer with the score results
    function createResultsFooter() {
      const rowDiv1 = createEl("div", "row")
      const colDiv1 = createEl("div", "col-md-10 offset-md-1")
      const hr = createEl("hr")
      const rowDiv = createEl("div", "row")
      const colDiv21 = createEl("div", "col-md-2")
      const colDiv22 = createEl("div", "col-md-10")
      const strong = createEl("strong")
      const resultDiv = createEl("div")
      resultDiv.id = "result"
      const br = createEl("br")

      rowDiv1.appendChild(colDiv1)
      colDiv1.appendChild(hr)
      colDiv1.appendChild(rowDiv)
      rowDiv.appendChild(colDiv21)
      colDiv21.appendChild(strong)
      strong.textContent = "Results:"
      rowDiv.appendChild(colDiv22)
      colDiv22.appendChild(resultDiv)
      rowDiv.appendChild(br)
      rowDiv.appendChild(br)
      rowDiv.appendChild(br)

      return rowDiv1
    }

    // creates the question card header 
    const createCardHeader = (question, index) => {
        const cardHeader = createEl("div", "card-header")
        cardHeader.innerText = `${index + 1}. ${question.question}`
        return cardHeader
    }

    // creates the question option element
    const createOption = (option, optionIndex, questionIndex, isCorrectAnswer) => {
        const optionLabel = document.createElement("label");

        const optionInput = document.createElement("input");
        optionInput.setAttribute("type", "radio");
        optionInput.setAttribute("name", "question" + questionIndex);
        optionInput.setAttribute("value", optionIndex);

        optionLabel.appendChild(optionInput);
        optionLabel.appendChild(document.createTextNode(" " + option));

        if (isCorrectAnswer) {
          badge = createEl("span", "badge badge-success")
          badge.textContent = "Correct"
          badge.style.display = "none";
          optionLabel.appendChild(badge);
        }

        return optionLabel
    }

    // create the question card with the header and options
    const createQuestionCard = (question, index) => {
        const cardDiv = createEl("div", "card question")
        const cardHeader = createCardHeader(question, index)
        cardDiv.appendChild(cardHeader)

        listGroup = createEl("ul", "list-group list-group-flush")

        question.options.forEach((option, optionIndex) => {
            const listGroupItem = createEl("li", "list-group-item")
            listGroup.appendChild(listGroupItem)

            const isCorrectAnswer = question.answer === optionIndex
            optionLabel = createOption(option, optionIndex, index, isCorrectAnswer)
            listGroupItem.appendChild(optionLabel)
        })

        cardDiv.appendChild(listGroup)

        return cardDiv
    }


    /* RENDERING FUNCTIONS */
    /* **************************************************
    ************************************************** */

    // Function to render the quiz with all questions
    function renderQuiz(quizData) {
      const quizContainer = document.getElementById("quiz-container");
      const rowDiv = createEl("div", "row")
      const colDiv = createEl("div", "col-md-10 offset-md-1")
      rowDiv.appendChild(colDiv)
      const quiz = createEl("div")
      quiz.id = "quiz"
      colDiv.appendChild(quiz)

      quizContainer.appendChild(rowDiv)
      const submitQuizDiv = createSubmitQuizFooter()
      const resultsDiv = createResultsFooter()
      quizContainer.appendChild(submitQuizDiv)
      quizContainer.appendChild(resultsDiv)

      quizData.forEach((question, index) => {
        const questionDiv = createQuestionCard(question, index)
        quiz.appendChild(questionDiv);
      });
    }


    /* BEHAVIOUR FUNCTIONS */
    /* **************************************************
    ************************************************** */

    // generate the quiz based on the prompts defined by the user
    const generateQuiz = async () => {
        const numQuestions = document.getElementById("numQuestions").value;
        const numOptions = document.getElementById("numOptions").value
        const subject = document.getElementById("subject").value;

        if (numQuestions > 0 && numOptions > 1 && subject){

          startLoading()
          const data = generatePayloadToApi(numQuestions, numOptions, subject)

          try {
              const response = await fetchChatCompletions(data)
              const myQuiz = parseOpenaiResponseToJson(response)
              setQuiz(myQuiz)
              renderQuiz(myQuiz)
              stopLoading()

          } catch (error) {
            stopLoading()
            showError(error)
          }
        }
    }

    // Function to submit the quiz and calculate the score
    function submitQuiz() {
      let score = 0;
      const quizData = getQuiz()
      const quizContainer = document.getElementById("quiz");
      const questionDivs = quizContainer.getElementsByClassName("question");
      for (let i = 0; i < questionDivs.length; i++) {
        const options = questionDivs[i].querySelectorAll("input[type=radio]");
        let userAnswer = null;
        let correctAnswer = quizData[i].answer;

        for (let j = 0; j < options.length; j++) {
          if (options[j].checked) {
            userAnswer = parseInt(options[j].value);
            break;
          }
        }

        if (userAnswer === correctAnswer) {
          score++;
        }
      }

      updateResults(score, quizData.length)
      showAllBadges()
    }
    
  </script>
</body>
</html>
